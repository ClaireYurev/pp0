## Palette Pal: Robust Document Linking System & Data Mapping

Here's the proposed database structure and data mapping to strongly link the various document types in Palette Pal and facilitate a seamless workflow.

**I. Database Structure (Illustrative - Specific SQL syntax will depend on the chosen database):**

We'll use PostgreSQL syntax for illustration.

```sql
-- Users (Freelancers & Clients)
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    user_type VARCHAR(10) NOT NULL CHECK (user_type IN ('freelancer', 'client')),
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    -- Other user details (password, etc.)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Projects
CREATE TABLE projects (
    project_id SERIAL PRIMARY KEY,
    freelancer_id INTEGER REFERENCES users(user_id),
    client_id INTEGER REFERENCES users(user_id),
    project_name VARCHAR(255) NOT NULL,
    project_description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Briefs (Initiated by the Client)
CREATE TABLE briefs (
    brief_id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(project_id),
    client_id INTEGER REFERENCES users(user_id),
    title VARCHAR(255) NOT NULL,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Proposals (Generated by the Freelancer)
CREATE TABLE proposals (
    proposal_id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(project_id),
    freelancer_id INTEGER REFERENCES users(user_id),
    brief_id INTEGER REFERENCES briefs(brief_id), -- Optional link to the originating brief
    title VARCHAR(255) NOT NULL,
    approach TEXT,
    timeline TEXT,
    deliverables TEXT,
    pricing_strategy VARCHAR(50), -- e.g., "Fixed Fee", "Hourly"
    total_amount DECIMAL(10, 2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Estimates (Generated by the Freelancer)
CREATE TABLE estimates (
    estimate_id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(project_id),
    freelancer_id INTEGER REFERENCES users(user_id),
    brief_id INTEGER REFERENCES briefs(brief_id), -- Optional link
    proposal_id INTEGER REFERENCES proposals(proposal_id), -- Optional link
    title VARCHAR(255) NOT NULL,
    description TEXT,
    total_amount DECIMAL(10, 2),
    payment_terms TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Contracts (Agreement between Freelancer & Client)
CREATE TABLE contracts (
    contract_id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(project_id),
    freelancer_id INTEGER REFERENCES users(user_id),
    client_id INTEGER REFERENCES users(user_id),
    proposal_id INTEGER REFERENCES proposals(proposal_id), -- Link to the accepted proposal
    estimate_id INTEGER REFERENCES estimates(estimate_id), -- Optional link to an estimate if no proposal
    title VARCHAR(255) NOT NULL,
    scope_of_work TEXT,
    payment_terms TEXT,
    timeline TEXT,
    intellectual_property TEXT,
    total_contract_value DECIMAL(10, 2),
    digital_signature_id VARCHAR(255), -- Link to external e-signature service
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Invoices (Request for Payment)
CREATE TABLE invoices (
    invoice_id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(project_id),
    contract_id INTEGER REFERENCES contracts(contract_id), -- Link to the relevant contract
    estimate_id INTEGER REFERENCES estimates(estimate_id), -- Optional, if no contract
    client_id INTEGER REFERENCES users(user_id),
    invoice_number VARCHAR(50) UNIQUE NOT NULL,
    issue_date DATE NOT NULL,
    due_date DATE NOT NULL,
    total_amount_due DECIMAL(10, 2) NOT NULL,
    payment_status VARCHAR(20) CHECK (payment_status IN ('pending', 'paid', 'partial', 'overdue', 'cancelled')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Invoice Line Items (Detailed Breakdown)
CREATE TABLE invoice_line_items (
    line_item_id SERIAL PRIMARY KEY,
    invoice_id INTEGER REFERENCES invoices(invoice_id),
    description TEXT NOT NULL,
    quantity DECIMAL(10, 2),
    unit_price DECIMAL(10, 2),
    total_price DECIMAL(10, 2)
);

-- Receipts (Proof of Payment)
CREATE TABLE receipts (
    receipt_id SERIAL PRIMARY KEY,
    invoice_id INTEGER REFERENCES invoices(invoice_id),
    payment_date DATE NOT NULL,
    payment_method VARCHAR(50),
    amount_received DECIMAL(10, 2) NOT NULL,
    transaction_id VARCHAR(255), -- Stripe transaction ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Change Orders (Amendments to Contracts)
CREATE TABLE change_orders (
    change_order_id SERIAL PRIMARY KEY,
    contract_id INTEGER REFERENCES contracts(contract_id),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    revised_scope TEXT,
    revised_timeline TEXT,
    revised_cost_impact DECIMAL(10, 2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**II. Data Mapping - Transferring Data Between Document Types:**

Here's how data fields should transfer when creating a new document based on an existing one within Palette Pal:

| **Source Document** | **Target Document** | **Data Fields to Transfer**                                                                                       | **Considerations/Transformations**                                                                                                                                                              |
| :------------------ | :------------------ | :---------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Brief**           | **Proposal**        | `project_id`, `client_id`, `title`, `content` (as background/context)                                             | May need to be reformatted or summarized. The `title` might be adjusted for the Proposal.                                                                                                         |
| **Brief**           | **Estimate**        | `project_id`, `client_id`, key aspects of `content` (relevant to cost breakdown)                                  | Requires more manual input to break down the brief into specific services and costs.                                                                                                                |
| **Proposal**        | **Estimate**        | `project_id`, `client_id`, `title`, relevant `deliverables` (as potential line items), potential `total_amount`    | May require breaking down the overall proposal amount into individual service costs.                                                                                                                |
| **Proposal**        | **Contract**        | `project_id`, `freelancer_id`, `client_id`, `title`, `approach`, `timeline`, `deliverables`, `pricing_strategy`, `total_amount` | Formalize the language, add legal clauses (using contract templates), specify payment terms. `total_amount` becomes `total_contract_value`.                                                        |
| **Estimate**        | **Contract**        | `project_id`, `freelancer_id`, `client_id`, `title`, `description` (as scope), `total_amount`, `payment_terms`    | Add missing contractual elements (IP, confidentiality, etc.). `total_amount` becomes `total_contract_value`. Scope may need more formal definition.                                                  |
| **Contract**        | **Invoice**         | `project_id`, `client_id`, `contract_id`,  client name/address, *line items based on contract deliverables/scope*, agreed-upon rates (derived from `total_contract_value` or project pricing), payment terms (for reference) |  **Crucially**, Palette Pal needs a way to select which *specific deliverables* from the contract are being invoiced in this instance. Calculate `total_amount_due`. Set `due_date`.                                |
| **Estimate**        | **Invoice**         | `project_id`, `client_id`, `estimate_id`, client name/address, `description` (as invoice detail), `total_amount` | Useful for simpler projects without a formal contract. Break down the `description` into more specific invoice line items.                                                                      |
| **Invoice**         | **Receipt**         | `invoice_id`, client name, `total_amount_due` (as `amount_received`), payment method, transaction ID (from Stripe) | This process should be largely automated upon successful payment through Stripe Connect.                                                                                                      |
| **Contract**        | **Change Order**    | `contract_id`, original project details (for context)                                                               | Users will primarily *add* new data describing the changes, but linking to the original contract is essential. The `revised_cost_impact` will influence future invoice generation.              |

**Key Implementation Details:**

*   **Foreign Keys are Crucial:** The `*_id` fields in each table, referencing other tables, are the backbone of the linking system. Ensure these are properly indexed for efficient querying.
*   **Optional Relationships:** Notice the use of optional foreign keys (e.g., `proposal_id` and `brief_id` in `estimates`). This reflects that a document might be created in isolation or based on different predecessors.
*   **Data Transformation Logic:**  When transferring data, you might need to transform it (e.g., breaking down a proposal's total into invoice line items). Implement this logic in your backend.
*   **User Interface Guidance:** The UI should clearly guide users through the process of creating linked documents, offering options to "Create Invoice from Contract," etc.
*   **Data Integrity:**  Implement validation rules to ensure data consistency across linked documents. For example, if the contract's total value changes, related invoices might need review.

By implementing this database structure and carefully mapping the data flow, Palette Pal can intelligently connect these freelance design documents, saving users significant time and reducing the potential for errors.
